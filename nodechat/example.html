<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>EventSource example</title>
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <script type="text/javascript" src="eventsource.js"></script>
  <script type="text/javascript">

    var lastSendedMessageId = {},
        lastSendedTime = null;

    function onDomReady() {
      setTimeout(function () { // prevent Chrome loading indication
        var msgs = document.getElementById('msgs'),
            es = new EventSource('events');
        es.addEventListener('message', function (event) {
          var div = document.createElement('div'),
              text = document.createTextNode(JSON.parse(event.data)),
              span;
          div.appendChild(text);
          if (event.lastEventId === lastSendedMessageId) {
            lastSendedMessageId = {};
            span = document.createElement('span');
            span.innerHTML = ' (ping: ' + (+new Date() - lastSendedTime) + 'ms) ';
            div.appendChild(span);
          }
          msgs.insertBefore(div, msgs.firstChild);
        }, false);
      }, 10);
    }

    setTimeout(onDomReady, 0);

    function post() {
      var message = document.getElementById('message').value;
      if (!message) {
        return false;
      }
      document.getElementById('message').value = '';

      lastSendedTime = +new Date();
      var xhr = new XMLHttpRequest();xhr = new XMLHttpRequest();
      xhr.open('POST', '?message=' + encodeURIComponent(message), true);
      xhr.onreadystatechange = function () {
        if (xhr.readyState === 4) {
          lastSendedMessageId = xhr.responseText;
        }
      };
      xhr.send(null);

      return false;
    }

  </script>
  <style type="text/css">
    #msgs div {
      border-top: 1px solid silver;
      overflow: hidden;
    }
    #msgs span {
      color: blue;
    }
  </style>
</head>
<body>
    <form action="?" onsubmit="return post();"><input type="text" name="message" id="message" required /><input type="submit" value="Send message" /></form>
    <div id="msgs"></div>
</body>
</html>